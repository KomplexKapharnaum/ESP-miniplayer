<!doctype html>
<html lang="en">
    <head>
      <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>

        <div class="blockfull server-info">
          <div class="header">KXKM // ESP-miniplayers</div>
          <div class="subheader">
            <div id="broadcastIP">connecting ..</div>
          </div>
        </div>

        <div id="channels-list">
        </div>

        <!-- Insert this line above script imports  -->
        <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

        <script src="/jquery/dist/jquery.js"></script>
        <script src="/socket.io/socket.io.js"></script>

        <!-- Insert this line after script imports -->
        <script>if (window.module) module = window.module;</script>

        <script>

        function pad(number, length) {
            var str = '' + number;
            while (str.length < length) str = '0' + str
            return str
        }

        function getClient(id, channel) {
          var cli_blk;
          // Find or create
          if ($('.player-'+id).length) cli_blk = $('.player-'+id)
          else {
            var ch_cont = $('.channel-'+channel).find('.devices');
            cli_blk = $('<div class="block player player-'+id+'">').appendTo( ch_cont )
            if (id < 1000) {
              $('<div class="subheader player-version">').appendTo(cli_blk)

              $('<div class="header player-title">')
                .append($('<span class="title">').html("Player "+id))
                .appendTo(cli_blk)
              $('<div class="subheader player-info">')
                    .append($('<span class="ip">'))
                    .appendTo(cli_blk).hide()

              $('<div class="subheader player-state">')
                    .append($('<span class="link">').html("link"))
                    .append($('<span class="sd">').html("sdcard"))
                    .append($('<span class="sync">').html("x").addClass("red"))
                    .append($('<span class="version">'))
                    .appendTo(cli_blk)
            }
            else $('<div class="header">')
                    .append($('<span class="title">').html("Emulator"))
                    .appendTo(cli_blk)

            $('<div class="subheader player-media">').appendTo(cli_blk)
            $('<div class="subheader player-error">').addClass('red').appendTo(cli_blk)

          }
          return cli_blk;
        }

        function updateClient(cli) {
          var cli_blk = getClient(cli['info']['id'], cli['info']['channel'])

          // State
          var state;
          if (cli['state'] == 'online') state = 'green';
          else if (cli['state'] == 'offline') state = 'yellow';
          else {
            state = 'red';
            if (cli['info']['id'] > 1000) {
              cli_blk.remove()
              return
            }
          }
          cli_blk.find(".header").removeClass('red green yellow').addClass(state)
          cli_blk.find(".player-version").html("v"+cli['info']['version'])

          // Info
          cli_blk.find(".player-info").find('.ip').html(cli['ip'])

          // State
          cli_blk.find(".player-state").find('.link').removeClass('red green').addClass(cli['info']['link']?"green":"red")
          cli_blk.find(".player-state").find('.sd').removeClass('red green').addClass(cli['info']['sd']?"green":"red")
          if (fileCount > 0) {
            var syncProgress = Math.round(cli['info']['sync']*100/fileCount)
            cli_blk.find(".player-state").find('.sync').html(syncProgress+"%").removeClass('red yellow green')
            if (syncProgress == 0) cli_blk.find(".player-state").find('.sync').addClass("red")
            else if (syncProgress < 100) cli_blk.find(".player-state").find('.sync').addClass("yellow")
            else cli_blk.find(".player-state").find('.sync').addClass("green")
          }

          // Media & error
          cli_blk.find(".player-media").html(cli['info']['media']).removeClass('red yellow').addClass(cli['info']['media']=='stop'?"red":"yellow")
          cli_blk.find(".player-error").html(cli['info']['error'])
        }

        function getChannel(nchan) {
          var ch_blk;
          // Find or create
          if ($('.channel-'+nchan).length) ch_blk = $('.channel-'+nchan)
          else {
            ch_blk = $('<div class="blockfull channel-'+nchan+'">').appendTo( $('#channels-list') )
            var ch_ctrl = $('<div class="channel">').appendTo(ch_blk)
              $('<div class="header">').html(" "+nchan).appendTo(ch_ctrl)
              $('<div class="subheader bank">').appendTo(ch_ctrl)
              // $('<div class="subheader loop">').appendTo(ch_ctrl)
              $('<div class="subheader cmd">').appendTo(ch_ctrl)
              $('<div class="player-tools">')
                .append( $('<button class="testbtn">test</button>').on('click', function() {socket.emit('channel.test', this.nchan)}.bind({nchan:nchan}) ))
                .append( $('<button class="stopbtn">stop</button>').on('click', function() {socket.emit('channel.stop', this.nchan)}.bind({nchan:nchan}) ))
                .append( $('<button class="loopbtn">loop</button>').on('click', function() {socket.emit('channel.loop', this.nchan)}.bind({nchan:nchan}) ))
                .append( $('<button class="emulbtn">emul</button>').on('click', function() {socket.emit('channel.emul', this.nchan)}.bind({nchan:nchan}) ))
                .appendTo(ch_ctrl)

            $('<div class="devices">').appendTo(ch_blk)


          }
          return ch_blk;
        }

        function updateChannel(data) {
          var ch_blk = getChannel(data['channel'])
          ch_blk.find('.bank').html("BANK: "+pad(data['bank'],3))
          ch_blk.find('.cmd').html("CMD: "+data['cmd'])

          ch_blk.find('.loopbtn').removeClass('green').addClass(data['loop']?'green':'')
          ch_blk.find('.emulbtn').removeClass('green').addClass(data['emul']?'green':'')
        }

         var fileCount = 0
         var socket = io.connect('http://127.0.0.1:8088');

         socket.on('connect', (data) => {
            socket.emit('join', 'Hello World');
         });

         socket.on('disconnect', () => {
           $('#channels-list').empty()
           $('#broadcastIP').html("Waiting for server..")
         })

         socket.on('snapshot', (data) => {
            // Server info
            $('#broadcastIP').html( "Broadcasting on "+data['server']['broadcastIP'] )
            fileCount = data['server']['fileCount']

            //Channels
            $('#channels-list').empty()
            for (var chan of data['channels']) {
              updateChannel(chan)
              for (var cli of chan['clients']) updateClient(cli)
            }
         });

         socket.on('updatecli', function(data) {
            updateClient(data)
         });

         socket.on('updatechan', function(data) {
          //  console.log(data)
            updateChannel(data)
         });

        </script>
    </body>
</html>
